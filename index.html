<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guy's Book Search & Save Engine</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Button hover effect */
        button:hover {
            background-color: #d2691e; /* Slightly darker color on hover */
            cursor: pointer;
        }

        /* Loading spinner */
        #loading-spinner {
            display: none;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Search suggestions dropdown */
        #suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>Google Books API Book Search</h1>
        <ul>
            <li><a href="#" class="btn">Search</a></li>
            <li><a href="lib.html" class="btn">Library</a></li>
        </ul>
    </div>

    <div class="container">
        <form id="search-form">
            <input type="text" id="search-input" placeholder="Enter a book title or author">
            <div id="suggestions"></div> <!-- Suggestions dropdown -->
            <button type="submit">Search</button>
            <button type="button" id="scan-button">Scan</button>
        </form>

        <!-- Scanner Section -->
        <div id="scanner-container">
            <h2>Barcode Scanner</h2>
            <video id="video" autoplay></video>
        </div>

        <div id="loading-spinner"></div> <!-- Loading spinner -->

        <div id="search-results"></div>
    </div>

    <script>
        var BASE_URL = 'https://www.googleapis.com/books/v1/volumes';

        // Function to scroll smoothly to the search results section
        function scrollToResults() {
            $('html, body').animate({
                scrollTop: $("#search-results").offset().top
            }, 1000);
        }

        // Show loading spinner
        function showLoadingSpinner() {
            $('#loading-spinner').show();
        }

        // Hide loading spinner
        function hideLoadingSpinner() {
            $('#loading-spinner').hide();
        }

        // Search event (form submission)
        $('#search-form').on('submit', function(event) {
            event.preventDefault();
            var query = $('#search-input').val();
            searchBook(query);
            scrollToResults();  // Scroll down to results after search
        });

        // Barcode scanning event
        $('#scan-button').on('click', function() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'), 
                },
                decoder: {
                    readers: ["ean_reader"] 
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    return;
                }
                Quagga.start(); 
                Quagga.onDetected(function(result) {
                    Quagga.stop(); 
                    var scannedISBN = result.codeResult.code; 
                    $('#search-input').val(scannedISBN); 
                    searchBook(scannedISBN); 
                    $('#video').remove(); 
                    scrollToResults();  // Scroll down to results after scanning
                });
            });
        });

        // Fetch book suggestions for autocomplete
        $('#search-input').on('input', function() {
            var query = $(this).val();
            if (query.length > 2) { // Start fetching after 2 characters
                $.get(BASE_URL, { 'q': query, 'maxResults': 5 }, function(data) {
                    var suggestions = data.items || [];
                    var suggestionsContainer = $('#suggestions');
                    suggestionsContainer.empty().show();
                    
                    suggestions.forEach(function(item) {
                        var title = item.volumeInfo.title || 'No Title';
                        $('<div>').addClass('suggestion-item').text(title).appendTo(suggestionsContainer)
                            .on('click', function() {
                                $('#search-input').val(title); // Set the input value
                                suggestionsContainer.hide(); // Hide the suggestions
                            });
                    });
                });
            } else {
                $('#suggestions').hide(); // Hide if input is less than 2 characters
            }
        });

        // Function to add a book to the library
        function addToLibrary(book) {
            let library = JSON.parse(localStorage.getItem('library')) || [];

            const newBook = {
                title: book.title,
                author: book.author,
                thumbnail: book.thumbnail,
                predefinedTag: 'TBR',
                customTag: '',
                dateAdded: new Date().toISOString()
            };

            library.push(newBook);
            localStorage.setItem('library', JSON.stringify(library));
            alert(`${book.title} has been added to your library!`);
            window.location.href = 'lib.html';
        }

        // Function to limit the description text
        function truncateText(text, wordCount) {
            var words = text.split(' ');
            if (words.length > wordCount) {
                return words.slice(0, wordCount).join(' ') + '...';
            }
            return text;
        }

        function searchBook(query) {
            var params = { 'q': query, 'maxResults': 20 };

            showLoadingSpinner(); // Show spinner before search

            $.get(BASE_URL, params, function(data) {
                hideLoadingSpinner(); // Hide spinner after search
                var books = data.items || [];
                var resultsContainer = $('#search-results');
                resultsContainer.empty();

                if (books.length > 0) {
                    $('<h2>').text('Search results for "' + query + '":').appendTo(resultsContainer);
                    $.each(books, function(index, item) {
                        var book = {
                            'title': item.volumeInfo.title || 'N/A',
                            'authors': item.volumeInfo.authors || 'N/A',
                            'description': item.volumeInfo.description || 'N/A',
                            'thumbnail': item.volumeInfo.imageLinks ? item.volumeInfo.imageLinks.thumbnail || 'N/A' : 'N/A',
                            'genres': item.volumeInfo.categories || ['N/A']
                        };
                        var bookResult = $('<div>').addClass('book-result')
                            .append($('<img>').addClass('book-thumbnail').attr('src', book.thumbnail))
                            .append($('<div>').addClass('book-details')
                                .append($('<h2>').text('Title: ' + book.title))
                                .append($('<h3>').text('Authors: ' + book.authors))
                                .append($('<h4>').text('Genres: ' + book.genres.join(', ')))
                                .append($('<a>').text('Buy on Amazon').attr('href', 'https://www.amazon.com/s?k=' + book.title.replace(/ /g, '+')).attr('target', '_blank'))
                                .append($('<p>').text('Description: ' + truncateText(book.description, 50)))  // Limited to 50 words
                                .append($('<button>').text('Add to Library').on('click', function() {
                                    addToLibrary(book);
                                })))
                            .appendTo(resultsContainer);
                    });
                } else {
                    $('<p>').text('No results found for "' + query + '"').appendTo(resultsContainer);
                }
            }).fail(function() {
                hideLoadingSpinner();
                console.error('Failed to fetch book data.');
            });
        }
    </script>
</body>
</html>
